<!DOCTYPE html>
<html lang="ru-ru">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Партиционирование | Блог Ивана Евтуховича</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Я долго считал партиционирование плохой практикой, а само слово не любил из-за кальки с английского, которую крайне
сложно выговорить с первого раза. И если слово «партиционирование» я так с первого раза и не выговариваю, то саму
практику пришлось признать как необходимое и неизбежное зло. Чтобы никто не подумал, что я делаю что-то плохое, я
использую для этого термин «инженерный компромисс», звучит умнее и не так обидно.">
    <meta name="generator" content="Hugo 0.87.0" />
    
      <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">

    

  
  
    <link rel="stylesheet" href="/ananke/dist/main.css_5c99d70a7725bacd4c701e995b969fea.css" >
  



  <link rel="stylesheet" href="/css/custom.css">


    
      
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />


    

    
    
    <meta property="og:title" content="Партиционирование" />
<meta property="og:description" content="Я долго считал партиционирование плохой практикой, а само слово не любил из-за кальки с английского, которую крайне
сложно выговорить с первого раза. И если слово «партиционирование» я так с первого раза и не выговариваю, то саму
практику пришлось признать как необходимое и неизбежное зло. Чтобы никто не подумал, что я делаю что-то плохое, я
использую для этого термин «инженерный компромисс», звучит умнее и не так обидно." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://evtuhovich.ru/blog/2013/02/24/partitioning/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2013-02-24T22:12:00+00:00" />
<meta property="article:modified_time" content="2013-02-24T22:12:00+00:00" />

<meta itemprop="name" content="Партиционирование">
<meta itemprop="description" content="Я долго считал партиционирование плохой практикой, а само слово не любил из-за кальки с английского, которую крайне
сложно выговорить с первого раза. И если слово «партиционирование» я так с первого раза и не выговариваю, то саму
практику пришлось признать как необходимое и неизбежное зло. Чтобы никто не подумал, что я делаю что-то плохое, я
использую для этого термин «инженерный компромисс», звучит умнее и не так обидно."><meta itemprop="datePublished" content="2013-02-24T22:12:00+00:00" />
<meta itemprop="dateModified" content="2013-02-24T22:12:00+00:00" />
<meta itemprop="wordCount" content="757">
<meta itemprop="keywords" content="PostgreSQL,partitioning," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Партиционирование"/>
<meta name="twitter:description" content="Я долго считал партиционирование плохой практикой, а само слово не любил из-за кальки с английского, которую крайне
сложно выговорить с первого раза. И если слово «партиционирование» я так с первого раза и не выговариваю, то саму
практику пришлось признать как необходимое и неизбежное зло. Чтобы никто не подумал, что я делаю что-то плохое, я
использую для этого термин «инженерный компромисс», звучит умнее и не так обидно."/>

	<meta name="yandex-verification" content="844263c66799f878" />

<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter40052600 = new Ya.Metrika({
                    id:40052600,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/40052600" style="position:absolute; left:-9999px;" alt="" /></div></noscript>



<script async src="https://www.googletagmanager.com/gtag/js?id=UA-28012309-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-28012309-1');
</script>


  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Блог Ивана Евтуховича
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/calendar/" title="Архив page">
              Архив
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/blog/" title="Блог page">
              Блог
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/life/" title="Жизнь page">
              Жизнь
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about/" title="Обо мне page">
              Обо мне
            </a>
          </li>
          
        </ul>
      
      



<a href="https://www.facebook.com/evtuhovich" target="_blank" class="link-transition facebook link dib z-999 pt3 pt0-l mr1" title="Facebook link" rel="noopener" aria-label="follow on Facebook——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://twitter.com/evtuhovich" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://www.instagram.com/evtuhovich/" target="_blank" class="link-transition instagram link dib z-999 pt3 pt0-l mr1" title="Instagram link" rel="noopener" aria-label="follow on Instagram——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M42.271,26.578v-0.006c0.502,0,1.005,0.01,1.508-0.002  c0.646-0.017,1.172-0.57,1.172-1.217c0-0.963,0-1.927,0-2.89c0-0.691-0.547-1.24-1.236-1.241c-0.961,0-1.922-0.001-2.883,0  c-0.688,0.001-1.236,0.552-1.236,1.243c-0.001,0.955-0.004,1.91,0.003,2.865c0.001,0.143,0.028,0.291,0.073,0.426  c0.173,0.508,0.639,0.82,1.209,0.823C41.344,26.579,41.808,26.578,42.271,26.578z M33,27.817c-3.384-0.002-6.135,2.721-6.182,6.089  c-0.049,3.46,2.72,6.201,6.04,6.272c3.454,0.074,6.248-2.686,6.321-6.043C39.254,30.675,36.462,27.815,33,27.817z M21.046,31.116  v0.082c0,4.515-0.001,9.03,0,13.545c0,0.649,0.562,1.208,1.212,1.208c7.16,0.001,14.319,0.001,21.479,0  c0.656,0,1.215-0.557,1.215-1.212c0.001-4.509,0-9.02,0-13.528v-0.094h-2.912c0.411,1.313,0.537,2.651,0.376,4.014  c-0.161,1.363-0.601,2.631-1.316,3.803s-1.644,2.145-2.779,2.918c-2.944,2.006-6.821,2.182-9.946,0.428  c-1.579-0.885-2.819-2.12-3.685-3.713c-1.289-2.373-1.495-4.865-0.739-7.451C22.983,31.116,22.021,31.116,21.046,31.116z   M45.205,49.255c0.159-0.026,0.318-0.049,0.475-0.083c1.246-0.265,2.264-1.304,2.508-2.557c0.025-0.137,0.045-0.273,0.067-0.409  V21.794c-0.021-0.133-0.04-0.268-0.065-0.401c-0.268-1.367-1.396-2.428-2.78-2.618c-0.058-0.007-0.113-0.02-0.17-0.03H20.761  c-0.147,0.027-0.296,0.047-0.441,0.08c-1.352,0.308-2.352,1.396-2.545,2.766c-0.008,0.057-0.02,0.114-0.029,0.171V46.24  c0.028,0.154,0.05,0.311,0.085,0.465c0.299,1.322,1.427,2.347,2.77,2.52c0.064,0.008,0.13,0.021,0.195,0.03H45.205z M33,64  C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>











    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        БЛОГ
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://evtuhovich.ru/blog/2013/02/24/partitioning/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://evtuhovich.ru/blog/2013/02/24/partitioning/&amp;text=%d0%9f%d0%b0%d1%80%d1%82%d0%b8%d1%86%d0%b8%d0%be%d0%bd%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://evtuhovich.ru/blog/2013/02/24/partitioning/&amp;title=%d0%9f%d0%b0%d1%80%d1%82%d0%b8%d1%86%d0%b8%d0%be%d0%bd%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">Партиционирование</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2013-02-24T22:12:00Z">February 24, 2013</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Я долго считал партиционирование плохой практикой, а само слово не любил из-за кальки с английского, которую крайне
сложно выговорить с первого раза. И если слово «партиционирование» я так с первого раза и не выговариваю, то саму
практику пришлось признать как необходимое и неизбежное зло. Чтобы никто не подумал, что я делаю что-то плохое, я
использую для этого термин «инженерный компромисс», звучит умнее и не так обидно.</p>
<p>Если бы партиционирование укладывалось в рамки <a href="http://www.postgresql.org/docs/9.2/static/ddl-partitioning.html">официальной документации</a>,
то и писать бы о нем не стоило. Но есть особенности, которые не сразу ясны из официальной документации, либо, вообще, в ней не
раскрываются.</p>
<p>Сразу скажу, что если есть возможность не делать партиционирование, то лучше его не делать. Зачастую дешевле увеличить
размер памяти у вашего сервера БД, чтобы он начал запросто переваривать большие таблицы. И только когда вы упретесь в
то, что такого количества памяти нет в продаже, стоит приступать к активным действиям.</p>
<p><a href="http://www.postgresql.org/docs/9.2/static/ddl-partitioning.html">Официальной документации</a> вполне достаточно для того,
чтобы партиционирование заработало. Более того, все дальнейшие рассуждения буду мало полезными для тех, кто официальную
документацию не читал.</p>
<p>Во-первых, в <code>CHECK CONSTRAINTS</code> должны быть IMMUTABLE функции. День у меня ушел на то, чтобы понять, что <a href="http://postgresql.1045698.n5.nabble.com/Constraint-exclusion-can-t-process-simple-constant-expressions-td4329606.html">TIMESTAMP
WITH TIME ZONE не является IMMUTABLE</a>.</p>
<p>Пример того, как выглядит генерация триггера на вставку в партиционированную таблицу. Для этой статьи я добавил
комментарии для больше понятности, но все равно выглядит громоздко.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CreatePartitionsForArchiveTransfers</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Migration</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">up</span>
    <span style="color:#75715e"># Таблица фактов называется archive_transfers, мы разобъем ее на части по месяцам</span>

    start <span style="color:#f92672">=</span> <span style="color:#66d9ef">Date</span><span style="color:#f92672">.</span>parse <span style="color:#e6db74">&#39;2011-10-01&#39;</span>
    trigger_parts <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>   <span style="color:#75715e"># здесь будут храниться куски триггера на вставку</span>
    <span style="color:#75715e"># сгенерируем триггер и таблицы до 2014-09 включительно - 3 года = 36 месяцев</span>
    <span style="color:#ae81ff">36</span><span style="color:#f92672">.</span>times <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>i<span style="color:#f92672">|</span>
      date <span style="color:#f92672">=</span> start <span style="color:#f92672">+</span> i<span style="color:#f92672">.</span>month
      <span style="color:#75715e"># таблицы будут иметь названия вида archive_transfers_2013_03</span>
      table_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;archive_transfers_</span><span style="color:#e6db74">#{</span>date<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y_%m&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

      <span style="color:#75715e"># b и e - сокращения от begin и end</span>
      b <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#39;&#34;</span> <span style="color:#f92672">+</span> date<span style="color:#f92672">.</span>to_time_in_current_zone<span style="color:#f92672">.</span>utc<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y-%m-%d %H:%M:%S&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&#34;</span>
      e <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#39;&#34;</span> <span style="color:#f92672">+</span>
        (date <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">.</span>month)<span style="color:#f92672">.</span>to_time_in_current_zone<span style="color:#f92672">.</span>utc<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y-%m-%d %H:%M:%S&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&#34;</span>

      trigger_parts <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; ( NEW.created_at &gt;= </span><span style="color:#e6db74">#{</span>b<span style="color:#e6db74">}</span><span style="color:#e6db74"> AND
</span><span style="color:#e6db74">               NEW.created_at &lt; </span><span style="color:#e6db74">#{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74"> ) THEN
</span><span style="color:#e6db74">              INSERT INTO </span><span style="color:#e6db74">#{</span>table_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> VALUES (NEW.*);
</span><span style="color:#e6db74">      &#34;</span>

      create_table table_name, <span style="color:#e6db74">:options</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;inherits (archive_transfers)&#34;</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>t<span style="color:#f92672">|</span>
      <span style="color:#66d9ef">end</span>

      <span style="color:#75715e"># индексы не наследуются, поэтому для каждой</span>
      <span style="color:#75715e"># дочерней таблицы их надо создавать заново</span>
      add_index table_name, <span style="color:#e6db74">:sender_id</span>
      add_index table_name, <span style="color:#e6db74">:receiver_id</span>

      <span style="color:#75715e"># для каждой дочерней табилцы создаем проверку,</span>
      <span style="color:#75715e"># чтобы в нее попадали только нужные данные</span>
      execute <span style="color:#e6db74">&#34;ALTER TABLE </span><span style="color:#e6db74">#{</span>table_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> ADD CHECK (
</span><span style="color:#e6db74">        created_at &gt;= </span><span style="color:#e6db74">#{</span>b<span style="color:#e6db74">}</span><span style="color:#e6db74"> AND
</span><span style="color:#e6db74">        created_at &lt; </span><span style="color:#e6db74">#{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">)&#34;</span>
    <span style="color:#66d9ef">end</span>

    execute <span style="color:#e6db74">%Q(
</span><span style="color:#e6db74">      CREATE OR REPLACE FUNCTION archive_transfers_insert_trigger()
</span><span style="color:#e6db74">      RETURNS TRIGGER AS $$
</span><span style="color:#e6db74">      BEGIN
</span><span style="color:#e6db74">          IF )</span> <span style="color:#f92672">+</span> trigger_parts<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;ELSEIF&#39;</span>) <span style="color:#f92672">+</span>
      <span style="color:#e6db74">%Q(    ELSE
</span><span style="color:#e6db74">              RAISE EXCEPTION &#39;Date out of range. Fix the archive_transfers_insert_trigger() function!&#39;;
</span><span style="color:#e6db74">          END IF;
</span><span style="color:#e6db74">          RETURN NULL;
</span><span style="color:#e6db74">      END;
</span><span style="color:#e6db74">      $$
</span><span style="color:#e6db74">      LANGUAGE plpgsql;
</span><span style="color:#e6db74">    )</span>

    execute <span style="color:#e6db74">%Q(
</span><span style="color:#e6db74">      CREATE TRIGGER insert_archive_transfers_trigger
</span><span style="color:#e6db74">      BEFORE INSERT ON archive_transfers
</span><span style="color:#e6db74">      FOR EACH ROW EXECUTE PROCEDURE archive_transfers_insert_trigger();)</span>

  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>После выполнения мы получим 36 новых таблиц в БД и триггер, похожий на этот.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">OR</span> <span style="color:#66d9ef">REPLACE</span> <span style="color:#66d9ef">FUNCTION</span> archive_transfers_insert_trigger()
<span style="color:#66d9ef">RETURNS</span> <span style="color:#66d9ef">TRIGGER</span> <span style="color:#66d9ef">AS</span> <span style="color:#960050;background-color:#1e0010">$$</span>
<span style="color:#66d9ef">BEGIN</span>
  <span style="color:#66d9ef">IF</span>  ( <span style="color:#66d9ef">NEW</span>.created_at <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;2011-09-30 20:00:00&#39;</span> <span style="color:#66d9ef">AND</span>
          <span style="color:#66d9ef">NEW</span>.created_at <span style="color:#f92672">&lt;</span> <span style="color:#e6db74">&#39;2011-10-31 20:00:00&#39;</span> ) <span style="color:#66d9ef">THEN</span>
         <span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> archive_transfers_2011_10 <span style="color:#66d9ef">VALUES</span> (<span style="color:#66d9ef">NEW</span>.<span style="color:#f92672">*</span>);
  ELSEIF ( <span style="color:#66d9ef">NEW</span>.created_at <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;2011-10-31 20:00:00&#39;</span> <span style="color:#66d9ef">AND</span>
          <span style="color:#66d9ef">NEW</span>.created_at <span style="color:#f92672">&lt;</span> <span style="color:#e6db74">&#39;2011-11-30 20:00:00&#39;</span> ) <span style="color:#66d9ef">THEN</span>
         <span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> archive_transfers_2011_11 <span style="color:#66d9ef">VALUES</span> (<span style="color:#66d9ef">NEW</span>.<span style="color:#f92672">*</span>);
<span style="color:#f92672">%</span> <span style="color:#960050;background-color:#1e0010">здесь</span> <span style="color:#960050;background-color:#1e0010">пропустим</span> <span style="color:#960050;background-color:#1e0010">много</span> <span style="color:#960050;background-color:#1e0010">таких</span> <span style="color:#960050;background-color:#1e0010">же</span> <span style="color:#960050;background-color:#1e0010">строчек</span>
  ELSEIF ( <span style="color:#66d9ef">NEW</span>.created_at <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;2014-08-31 20:00:00&#39;</span> <span style="color:#66d9ef">AND</span>
          <span style="color:#66d9ef">NEW</span>.created_at <span style="color:#f92672">&lt;</span> <span style="color:#e6db74">&#39;2014-09-30 20:00:00&#39;</span> ) <span style="color:#66d9ef">THEN</span>
         <span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> archive_transfers_2014_09 <span style="color:#66d9ef">VALUES</span> (<span style="color:#66d9ef">NEW</span>.<span style="color:#f92672">*</span>);
  <span style="color:#66d9ef">ELSE</span>
     RAISE <span style="color:#66d9ef">EXCEPTION</span> <span style="color:#e6db74">&#39;Date out of range.  Fix the archive_transfers_insert_trigger() function!&#39;</span>;
  <span style="color:#66d9ef">END</span> <span style="color:#66d9ef">IF</span>;
  <span style="color:#66d9ef">RETURN</span> <span style="color:#66d9ef">NULL</span>;
<span style="color:#66d9ef">END</span>;
<span style="color:#960050;background-color:#1e0010">$$</span>
<span style="color:#66d9ef">LANGUAGE</span> plpgsql;

</code></pre></div><p>При партиционировании перестает работать <code>RETURNING</code>, а это значит, что при вставке новой записи нельзя узнать ее
id. Для этого существует <a href="https://gist.github.com/copiousfreetime/59067">костыль</a>, который на каждую вставку делает
дополнительную вставку и удаление, чтобы получить id записи. Я не рискнул использовать его в бою, поскольку у нас и так
очень интенсивная нагрузка на БД.</p>
<p>Более того, надо понимать, что в случае с партиционироваными таблицами, вы можете иметь одинаковые id для разных
записей, так как уникальность id проверяется (если проверяется) только на уровне конкретной дочерней таблицы. Если вы
вставляете данные только в главную таблицу <code>archive_transfers</code>, то id гарантированно будут отличаться, потому что
триггер использует sequence от главной таблицы. Но ничего не запрещает вам вставить в дочернюю таблицу данные напрямую.</p>
<p>Какой выигрыш от такого усложнения? Во-первых, вместо одного большого индекса у вас будет теперь много маленьких,
которые помещаются в память. Если вам надо сделать выборку по дате, то seq scan будет идти только по нужным партициям. В
нашем случае, например, все запросы, в основном, делаются по последнему месяцу, поэтому она оказывается в кэше БД и,
самое главное, помещается туда целиком. А как мы знаем, БД для web-проекта либо помещается в память, либо не работает,
но об этом я напишу как-нибудь в другой раз.</p>
<p>Сам понимаю, что получилось немного сумбурно, поэтому с радостью раскрою непонятные вопросы в комментариях.</p><ul class="pa0">
  
   <li class="list">
     <a href="/tags/postgresql" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">PostgreSQL</a>
   </li>
  
   <li class="list">
     <a href="/tags/partitioning" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">partitioning</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "blog-evtuhovich" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Схожие</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/2013/01/27/locks/">Блокировки в PostgreSQL</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/2013/01/09/fix-db-on-fly/">Ремонт БД на лету с помощью pg_repack</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/2012/10/10/index-only-scan/">Index Only Scan в Postgresql 9.2</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/2012/07/27/backup/">Barman и WAL-E</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/2012/07/14/collate-osx-postgres/">Проблема с сортировкой русских слов в Postgres на OSX</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/2012/03/14/postgresql-json/">Поддержка JSON в PostgreSql 9.2</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/2012/01/23/hstore/">Hstore — key-value расширение для postgresql</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/2011/12/27/bible/">Библия PostgreSQL</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/2009/06/05/pgq-londiste-plugin/">PgQ и Londiste</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/2009/05/22/live-table-migration/">Перенос таблицы в другую базу данных postgres без простоя приложения</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/2009/04/08/concurent-index/">Конкурентное пересоздание индексов в postgresql</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/2009/04/04/queue/">Использование очередей в высоконагруженных проектах</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/2009/03/20/big-tables/">PosgtreSql, миграции и огромные таблицы</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://evtuhovich.ru/" >
    &copy;  Блог Ивана Евтуховича 2021 
  </a>
    <div>



<a href="https://www.facebook.com/evtuhovich" target="_blank" class="link-transition facebook link dib z-999 pt3 pt0-l mr1" title="Facebook link" rel="noopener" aria-label="follow on Facebook——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://twitter.com/evtuhovich" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://www.instagram.com/evtuhovich/" target="_blank" class="link-transition instagram link dib z-999 pt3 pt0-l mr1" title="Instagram link" rel="noopener" aria-label="follow on Instagram——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M42.271,26.578v-0.006c0.502,0,1.005,0.01,1.508-0.002  c0.646-0.017,1.172-0.57,1.172-1.217c0-0.963,0-1.927,0-2.89c0-0.691-0.547-1.24-1.236-1.241c-0.961,0-1.922-0.001-2.883,0  c-0.688,0.001-1.236,0.552-1.236,1.243c-0.001,0.955-0.004,1.91,0.003,2.865c0.001,0.143,0.028,0.291,0.073,0.426  c0.173,0.508,0.639,0.82,1.209,0.823C41.344,26.579,41.808,26.578,42.271,26.578z M33,27.817c-3.384-0.002-6.135,2.721-6.182,6.089  c-0.049,3.46,2.72,6.201,6.04,6.272c3.454,0.074,6.248-2.686,6.321-6.043C39.254,30.675,36.462,27.815,33,27.817z M21.046,31.116  v0.082c0,4.515-0.001,9.03,0,13.545c0,0.649,0.562,1.208,1.212,1.208c7.16,0.001,14.319,0.001,21.479,0  c0.656,0,1.215-0.557,1.215-1.212c0.001-4.509,0-9.02,0-13.528v-0.094h-2.912c0.411,1.313,0.537,2.651,0.376,4.014  c-0.161,1.363-0.601,2.631-1.316,3.803s-1.644,2.145-2.779,2.918c-2.944,2.006-6.821,2.182-9.946,0.428  c-1.579-0.885-2.819-2.12-3.685-3.713c-1.289-2.373-1.495-4.865-0.739-7.451C22.983,31.116,22.021,31.116,21.046,31.116z   M45.205,49.255c0.159-0.026,0.318-0.049,0.475-0.083c1.246-0.265,2.264-1.304,2.508-2.557c0.025-0.137,0.045-0.273,0.067-0.409  V21.794c-0.021-0.133-0.04-0.268-0.065-0.401c-0.268-1.367-1.396-2.428-2.78-2.618c-0.058-0.007-0.113-0.02-0.17-0.03H20.761  c-0.147,0.027-0.296,0.047-0.441,0.08c-1.352,0.308-2.352,1.396-2.545,2.766c-0.008,0.057-0.02,0.114-0.029,0.171V46.24  c0.028,0.154,0.05,0.311,0.085,0.465c0.299,1.322,1.427,2.347,2.77,2.52c0.064,0.008,0.13,0.021,0.195,0.03H45.205z M33,64  C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>










</div>
  </div>
</footer>

  </body>
</html>
